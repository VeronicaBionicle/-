.device ATmega16
.include "m16def.inc"

.CSEG
ldi R16,low(RAMEND)
ldi R17,High(RAMEND)
out SPL,R16
out SPH,R17

LDI 	R16,0		; Загружаем адрес нулевой ячейки
	LDI 	R17,0	 ; EEPROM 
	LDI 	R21,15	; и хотим записать в нее число 15
	RCALL 	EEWrite 	; вызываем процедуру записи.
LDI 	R16,0		; Загружаем адрес нулевой ячейки
	LDI 	R17,0		; EEPROM из которой хотим прочитать байт
	RCALL 	EERead  ; вызываем процедуру чтения. После которой 
				   ; в R21 будет считанный байт.

EEWrite:
	
SBIC	EECR,EEWE ; Ждем готовности памяти к записи. Крутимся в цикле
	RJMP	EEWrite 		; до тех пор пока не очистится флаг EEWE
 
	CLI				; Затем запрещаем прерывания.
	OUT 	EEARL,R16 		; Загружаем адрес нужной ячейки
	OUT 	EEARH,R17  	; старший и младший байт адреса
	OUT 	EEDR,R21 	 ; и сами данные, которые нам нужно загрузить
 
	SBI 	EECR,EEMWE		; взводим предохранитель
	SBI 	EECR,EEWE		; записываем байт
 
	SEI 				; разрешаем прерывания
	RET 				; возврат из процедуры
 
EERead:
	
	SBIC 	EECR,EEWE  ;Ждем пока будет завершена прошлая запись.
	RJMP	EERead			; также крутимся в цикле.
	OUT 	EEARL, R16  ; загружаем адрес нужной ячейки
	OUT  	EEARH, R17  ; его старшие и младшие байты
	SBI 	EECR,EERE  ; Выставляем бит чтения
	IN 	R21, EEDR 	 ; Забираем из регистра данных результат
	RET
